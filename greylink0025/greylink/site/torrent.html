<HTML><TITLE>greylink - интеграция с протоколом BitTorrent</TITLE>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251"/>
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon"/>
<link rel="icon" href="favicon.ico" type="image/x-icon"/>
</head>
<BODY bgcolor=#808080>
<center>Интеграция с протоколом BitTorrent</center>
<hr/>

<p/><b><font size="+1">Настройка портов</font></b></br>
<p/>Входящие соединения протокола BitTorrent используют
тот же TCP-порт, что и dc-соединения. Клиент, правильно работающий
в активном режиме, не требует дополнительной настройки.
Клиент, работающий в пассивном режиме, не может раздавать файлы
по протоколу BitTorrent, за исключением случаев, когда
раздача происходит тому же активному источнику, от которого
производится скачивание
<p/>UDP-протоколы передачи файлов и DHT не поддерживаются,
поэтому настройка UDP-порта не требуется

<p/><b><font size="+1">Хеши в torrent-файле</font></b></br>
<p/>torrent-файл состоит из нескольких разделов. Содержимое раздачи
находится в разделе 'info' и представляет собой список файлов
(список записей "имя файла, размер файла"), размер блока хеша (piece_size) и
список SHA1-хешей каждого блока раздачи, как если бы
все файлы раздачи были слеплены в один файл и
поделены на блоки размера piece_size.

<p/>Как видно, torrent-файл не содержит ни хеша всей раздачи,
ни хеша какого-либо отдельного файла раздачи. Для идентификации
раздачи на трекере torrent-клиенты подсчитывают
SHA1-хеш всего раздела 'info' и называют это значение инфо-хешем (infohash).
Для удобства интеграции с dc++ мы будем идентифицировать отдельные файлы
в раздаче парой (infohash, номер файла в раздаче).


<p/><b><font size="+1">Загрузка torrent-файла</font></b></br>

<p/>Выбор torrent-файла происходит аналогично выбору сохранённого файл-листа или dcls-файла:
<ul><li>из меню "Файл" - "Открыть файл"</li>
<li>перетаскиванием файла из окна проводника</li>
<li>повторным запуском программы с параметром - полным именем torrent-файла
(обеспечивая этим стандартные механизмы Windows "Открыть с помощью..." и регистрацию
обработчика двойного клика файла *.torrent)</li>
</ul>

Появляется список файлов в раздаче, из которого можно выбрать нужные для
скачивания, указать приоритет скачивания и папку, куда сохранить файлы.
После установки опций, файлы добавляются в очередь скачивания, но без
TTH-хеша, а с SHA1

<p/><b><font size="+1">Поиск источников</font></b></br>

<p/>Обычный способ получить список источников для скачивания - послать на трекер
команду "начало скачивания". Другой способ найти источники для раздачи - провести
tth-поиск на хабе с SHA1-хешем вместо TTH. Поскольку значение SHA1 короче, чем
TTH, оно дополняется случайными байтами. Таким образом невозможно определить,
является ли поисковый запрос запросом на поиск SHA1, хаб не имеет возможности
фильтровать такие запросы. dc-клиент, имеющий раздачу с искомым SHA1, отвечает
поисковыми ответами двух типов:
<br/>1. (ip-адрес, порт) раздающего источника, который получен от трекера,
или от другого dc-клиента. Считается, что указанный порт принимает запросы
по протоколу BitTorrent.
<br/>2. Информация о наличии TTH-хешей для искомой раздачи: base64-кодированый
битовый вектор, определяющий, есть ли TTH для каждого отдельного файла раздачи. Если
файлов в раздаче слишком много, клиент может выбрать краткую форму ответа:
"tth есть для всех файлов" или "tth нет вообще".
<p/>Если с помощью хаб-поиска клиент определил, что у другого клиента
есть TTH-информация о torrent-раздаче, он может запросить эту информацию
через ADC GET как папку файл-листа с именем типа /0123456789abcdef..123.sha,
где перед .sha указан SHA1-хеш раздачи

<p/><b><font size="+1">Скачивание файлов</font></b></br>

<p/>Если известен BitTorrent-источник (ip+порт), скачивание происходит
по протоколу BitTorrent. Одновременно, если известен TTH скачиваемого файла,
сегменты этого файла могут скачиватья с пользователей хаба по известному TTH.

<p/><b><font size="+1">Раздача файлов</font></b></br>

<p/>Ничем не отличается от стандартов, принятых в BitTorrent и DC++:
раздаваемые через DC++ файлы должны быть в шаре, раздаваемые торренты
должны быть в состоянии Downloading или Seeding

</BODY></HTML>